<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVault - Free File Downloads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
        }
        .container {
            max-width: 900px;
        }
        .file-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border-color: #58a6ff;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.setLogLevel = setLogLevel;
    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-blue-400 mb-2 tracking-wider">
                OpenVault
            </h1>
            <p class="text-xl text-gray-400">Your free, public archive for projects and files.</p>
            <p id="authStatus" class="text-sm mt-1 text-gray-500"></p>
        </header>

        <!-- Main Downloadable File List -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold mb-6 border-b border-gray-700 pb-2 text-gray-300">Available Downloads</h2>
            <div id="fileList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Download cards will be inserted here by JavaScript -->
                <p id="loadingMessage" class="col-span-full text-center text-gray-500">Loading files...</p>
            </div>
        </section>

        <!-- Admin Panel (Only visible to the user who signs in) -->
        <section id="adminPanel" class="hidden border-4 border-dashed border-red-500 p-6 rounded-xl bg-gray-800/50">
            <h2 class="text-2xl font-bold mb-4 text-red-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Admin Panel: Add New File
            </h2>
            <p class="mb-4 text-sm text-red-300">
                NOTE: This stores the file's link, not the file itself. You must upload your zip/file to an external service (like Google Drive or Dropbox) first and get a public **direct download link**.
            </p>
            <form id="addFileForm" class="space-y-4">
                <div>
                    <label for="fileName" class="block mb-1 text-sm font-medium">File Name (e.g., Project_v1.0)</label>
                    <input type="text" id="fileName" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="fileUrl" class="block mb-1 text-sm font-medium">Direct Download Link (URL)</label>
                    <input type="url" id="fileUrl" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="fileDescription" class="block mb-1 text-sm font-medium">Short Description</label>
                    <textarea id="fileDescription" rows="2" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <button type="submit" id="submitButton" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-200">
                    Add Downloadable File
                </button>
                <p id="formMessage" class="text-center text-sm mt-2 text-yellow-400"></p>
            </form>
        </section>
    </div>

    <script type="module">
        // Firebase Globals (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // FIX: The ternary operator was missing the 'false' condition, causing a SyntaxError. Added an empty object as a fallback.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Element References
        const fileListContainer = document.getElementById('fileList');
        const adminPanel = document.getElementById('adminPanel');
        const authStatus = document.getElementById('authStatus');
        const addFileForm = document.getElementById('addFileForm');
        const submitButton = document.getElementById('submitButton');
        const formMessage = document.getElementById('formMessage');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // Firebase Instances
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use the provided auth token for sign-in or sign in anonymously
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        authStatus.textContent = `User ID: ${currentUserId} | Status: Signed In`;
                        adminPanel.classList.remove('hidden');
                    } else {
                        currentUserId = null;
                        authStatus.textContent = 'Status: Anonymous';
                        adminPanel.classList.add('hidden');
                    }
                    isAuthReady = true;
                    // Start listening for data once auth is ready
                    if (db) listenForDownloads(); 
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                authStatus.textContent = `Error: Failed to connect to Firebase.`;
            }
        }

        /**
         * Renders the list of downloadable files to the UI.
         * @param {Array<Object>} downloads 
         */
        function renderDownloads(downloads) {
            fileListContainer.innerHTML = '';
            
            if (downloads.length === 0) {
                fileListContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">No files uploaded yet. Use the Admin Panel below to add one!</p>`;
                return;
            }

            downloads.forEach(file => {
                const extension = file.url ? file.url.split('.').pop().toUpperCase() : 'FILE';
                const date = file.timestamp?.toDate ? file.timestamp.toDate().toLocaleDateString() : 'N/A';

                const card = document.createElement('div');
                card.className = 'file-card p-6 rounded-lg bg-gray-800 border border-gray-700 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xl font-semibold text-blue-400">${file.name}</h3>
                            <span class="text-xs font-mono px-3 py-1 rounded-full bg-gray-700 text-green-400">${extension}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">${file.description || 'No description provided.'}</p>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <p class="text-xs text-gray-500">Uploaded: ${date}</p>
                        <a href="${file.url}" target="_blank" rel="noopener noreferrer" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Download
                        </a>
                    </div>
                `;
                fileListContainer.appendChild(card);
            });
        }

        /**
         * Sets up the real-time listener for the downloads collection.
         */
        function listenForDownloads() {
            if (!db || !isAuthReady) return;

            // Public path for collaborative/shared data
            const downloadsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'downloads');
            const q = query(downloadsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const downloads = [];
                snapshot.forEach(doc => {
                    downloads.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by timestamp descending (newest first)
                downloads.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderDownloads(downloads);
            }, (error) => {
                console.error("Error listening to downloads:", error);
                loadingMessage.textContent = 'Failed to load files. Check console for details.';
            });
        }

        /**
         * Handles the form submission to add a new file record.
         */
        async function handleAddFile(e) {
            e.preventDefault();
            
            if (!db || !currentUserId) {
                formMessage.textContent = "Error: Not authorized to add files.";
                return;
            }

            const fileName = document.getElementById('fileName').value.trim();
            const fileUrl = document.getElementById('fileUrl').value.trim();
            const fileDescription = document.getElementById('fileDescription').value.trim();

            if (!fileName || !fileUrl) {
                formMessage.textContent = "File Name and Download Link are required.";
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            formMessage.textContent = 'Processing...';

            // Public path for collaborative/shared data
            const downloadsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'downloads');
            
            const fileData = {
                name: fileName,
                url: fileUrl,
                description: fileDescription,
                uploaderId: currentUserId, // Store who added it
                timestamp: serverTimestamp(),
            };

            try {
                await addDoc(downloadsCollectionRef, fileData);
                formMessage.textContent = `Success! '${fileName}' has been added.`;
                addFileForm.reset();
            } catch (error) {
                console.error("Error adding document:", error);
                formMessage.textContent = "Error adding file. Please try again.";
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Add Downloadable File';
            }
        }

        // --- Event Listeners and Initial Load ---
        addFileForm.addEventListener('submit', handleAddFile);
        
        window.onload = initFirebase;
    </script>
</body>
</html>